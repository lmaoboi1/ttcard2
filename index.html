<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Coin Catcher</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (for icons) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- ADJUST SCORE COIN POSITION HERE --- */
            /* Change these values to move the 5 coins on the card */
            --score-coin-container-top: 18%; /* 'y' position */
            --score-coin-container-left: 2.5%; /* 'x' position */
            --score-coin-container-translate: -50% -60%; /* Fine-tune centering */
            
            /* --- ADJUST SCORE COIN SIZE HERE --- */
            --score-coin-width: 2.7rem; /* 32px */
            --score-coin-height: 2.7rem; /* 32px */
            --score-coin-md-width: 2.5rem; /* 40px */
            --score-coin-md-height: 2.5rem; /* 40px */
            /* ----------------------------------- */
        }

        body {
            font-family: 'Inter', sans-serif;
            /* Prevent text selection and blue highlights on tap */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Animated Background - Cinematic and Colorful */
        .animated-background-cinematic {
            background: linear-gradient(-45deg, #FF6EC7, #6633FF, #00C9FF, #92FE9D, #FF6EC7);
            background-size: 600% 600%; /* Increased size for more spread */
            animation: gradient-animation-cinematic 25s ease infinite; /* Slower, more flowing animation */
        }

        @keyframes gradient-animation-cinematic {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Bouncy Pop-In Animation for the score coins */
        @keyframes bouncy-pop {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
            80% {
                transform: scale(0.95);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        .animate-bouncy-pop {
            animation: bouncy-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* This new rule controls the score coin size */
        .score-coin-img {
            width: var(--score-coin-width);
            height: var(--score-coin-height);
        }
        @media (min-width: 768px) {
            .score-coin-img {
                width: var(--score-coin-md-width);
                height: var(--score-coin-md-height);
            }
        }
        
        /* Coin styling */
        .coin {
            position: absolute;
            width: 70px; /* Bigger coins */
            height: 70px; /* Bigger coins */
            background-image: url('https://i.ibb.co/S42SJwyH/TTcoin.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            /* Optimize for 'right' animation */
            will-change: right; 
            /* Start from right, just off-screen */
            right: -80px; 
        }

        /* Confetti particle style */
        .confetti {
            position: absolute;
            opacity: 0;
            animation: fall 4s forwards;
            pointer-events: none;
            z-index: 50;
        }

        @keyframes fall {
            0% {
                opacity: 1;
                transform: translateY(-10vh) rotateZ(0deg) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotateZ(720deg) scale(0.5);
            }
        }
    </style>
</head>
<body class="animated-background-cinematic text-zinc-900 h-screen w-screen overflow-hidden relative">

    <!-- Start Screen Overlay -->
    <div id="start-screen" class="absolute inset-0 z-50 flex items-center justify-center backdrop-blur-md">
        <button id="start-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 text-xl sm:py-5 sm:px-10 sm:text-2xl rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95 flex items-center space-x-3 sm:space-x-4">
            <i class="fas fa-play text-2xl sm:text-3xl"></i>
            <span>PLAY NOW</span>
        </button>
    </div>

    <!-- Card Area - Now visible on start screen (z-51) -->
    <div id="card-area" class="absolute top-8 left-1/2 -translate-x-1/2 z-[51] flex flex-col items-center transition-all duration-500">
        <!-- The Card Image -->
        <img src="https://i.ibb.co/9HZkHp6M/TTcard.png" 
             alt="Card"
             class="w-80 max-w-[90vw] h-auto shadow-xl rounded-lg" 
             onerror="this.src='https://placehold.co/320x180/ccc/999?text=Card'">
        
        <!-- The 5 "Collected" Coin Icons (initially hidden) -->
        <div id="score-coins" class="absolute" style="
            top: var(--score-coin-container-top); 
            left: var(--score-coin-container-left); 
            transform: translate(var(--score-coin-container-translate)); 
            display: flex; gap: 0.25rem;">
            <img id="score-coin-1" src="https://i.ibb.co/S42SJwyH/TTcoin.png" class="score-coin-img opacity-0 scale-0" alt="Score Coin">
            <img id="score-coin-2" src="https://i.ibb.co/S42SJwyH/TTcoin.png" class="score-coin-img opacity-0 scale-0" alt="Score Coin">
            <img id="score-coin-3" src="https://i.ibb.co/S42SJwyH/TTcoin.png" class="score-coin-img opacity-0 scale-0" alt="Score Coin">
            <img id="score-coin-4" src="https://i.ibb.co/S42SJwyH/TTcoin.png" class="score-coin-img opacity-0 scale-0" alt="Score Coin">
            <img id="score-coin-5" src="https://i.ibb.co/S42SJwyH/TTcoin.png" class="score-coin-img opacity-0 scale-0" alt="Score Coin">
        </div>
    </div>

    <!-- Game Area (for spawning coins) -->
    <div id="game-area" class="absolute inset-0 w-full h-full z-0">
        <!-- Coins will be appended here by JS -->
    </div>

    <!-- Draggable Chest -->
    <img id="chest" 
         src="https://i.ibb.co/WNd3dzNs/Chat-GPT-Image-22-2025-12-58-21-1.png" 
         alt="Chest" 
         class="w-32 h-32 absolute left-4 bottom-1/2 translate-y-1/2 z-20 cursor-ns-resize object-contain transition-all duration-500 ease-out opacity-0 translate-x-[-100px]" 
         style="touch-action: none;"
         onerror="this.src='https://placehold.co/128x128/555/FFF?text=Chest'">

    <!-- Withdraw Button -->
    <button id="withdraw-button" class="hidden absolute bottom-10 sm:bottom-20 left-1/2 -translate-x-1/2 z-30 bg-gradient-to-r from-cyan-400 to-blue-500 text-white font-bold py-3 px-10 text-base sm:py-4 sm:px-12 sm:text-lg rounded-full shadow-lg transition-all duration-300 hover:scale-105 active:scale-95 animate-pulse">
        Withdraw Coins
    </button>

    <!-- Username Popup Modal -->
    <div id="username-popup" class="hidden absolute inset-0 z-40 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center transform scale-95 opacity-0 transition-all duration-300" id="popup-content">
            <h2 class="text-xl sm:text-2xl font-bold text-zinc-900 mb-4">Enter Username</h2>
            <p class="text-zinc-500 mb-6 text-sm">Enter your username to withdraw.</p>
            <input id="username-input" type="text" class="w-full bg-zinc-100 border border-zinc-300 rounded-lg p-3 text-zinc-900 placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="YourUsername">
            <button id="proceed-button" class="mt-6 w-full bg-gradient-to-r from-cyan-400 to-blue-500 text-white font-bold py-3 px-6 rounded-full shadow-lg text-lg transition-all duration-300 hover:scale-105 active:scale-95">
                Proceed
            </button>
        </div>
    </div>

    <!-- Congratulations Screen -->
    <div id="congrats-screen" class="hidden absolute inset-0 z-50 animated-background-cinematic flex flex-col items-center justify-center p-4 text-center">
        <!-- Confetti Container -->
        <div id="confetti-container" class="absolute inset-0"></div>
        
        <!-- Added a semi-transparent white overlay to ensure text readability -->
        <div class="absolute inset-0 bg-white/30 backdrop-blur-sm z-[1]"></div> 

        <div class="relative z-10 transform scale-95 opacity-0 transition-all duration-500" id="congrats-content">
            <h1 class="text-4xl sm:text-5xl font-extrabold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-600">Congratulations!</h1>
            <p class="text-lg sm:text-xl text-zinc-600 mb-2">Coins withdrawn for</p>
            <p id="final-username" class="text-2xl sm:text-3xl font-bold text-cyan-500"></p>
            <button id="play-again-button" class="mt-8 sm:mt-12 bg-zinc-200 text-zinc-800 font-bold py-3 px-6 text-base sm:py-3 sm:px-8 sm:text-lg rounded-full shadow-lg text-lg transition-all duration-300 hover:bg-zinc-300 active:scale-95">
                Play Again
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const startScreen = document.getElementById('start-screen');
            const startButton = document.getElementById('start-button');
            const chestEl = document.getElementById('chest');
            const gameArea = document.getElementById('game-area');
            const withdrawButton = document.getElementById('withdraw-button');
            const usernamePopup = document.getElementById('username-popup');
            const popupContent = document.getElementById('popup-content');
            const proceedButton = document.getElementById('proceed-button');
            const usernameInput = document.getElementById('username-input');
            const congratsScreen = document.getElementById('congrats-screen');
            const congratsContent = document.getElementById('congrats-content');
            const finalUsername = document.getElementById('final-username');
            const playAgainButton = document.getElementById('play-again-button');
            const confettiContainer = document.getElementById('confetti-container');
            const scoreCoinElements = [
                document.getElementById('score-coin-1'),
                document.getElementById('score-coin-2'),
                document.getElementById('score-coin-3'),
                document.getElementById('score-coin-4'),
                document.getElementById('score-coin-5'),
            ];

            // --- Game State ---
            let isDragging = false;
            let totalCoinsCaught = 0;
            let scoreCoinsOnCard = 0;
            let isGameActive = false; // Game starts inactive
            let activeCoins = []; // Will store { element, hasCollided }
            let lastCoinTop = 0; // Track last coin's vertical position
            let animationFrameId = null;
            let coinSpawnInterval = null;
            let lastTimestamp = 0; // For time-based animation

            // --- Constants ---
            const screenWidth = window.innerWidth;
            // Speed: pixels per second. (e.g., screenWidth / 2.5 = cross screen in 2.5s)
            const coinSpeed = screenWidth / 2.5; 
            const minVerticalDistance = 80; // Min pixels between coins

            // --- Chest Drag Logic ---
            function onDragStart(e) {
                if (!isGameActive) return; // Only allow drag when game is active
                isDragging = true;
                chestEl.classList.remove('cursor-ns-resize');
                chestEl.classList.add('active:cursor-ns-resize');
                chestEl.style.bottom = 'auto'; // Allow setting 'top'
                // Prevent default behavior, especially for touch
                if (e.type === 'touchstart') {
                    e.preventDefault();
                }
            }

            function onDragEnd(e) {
                isDragging = false;
                chestEl.classList.add('cursor-ns-resize');
                chestEl.classList.remove('active:cursor-ns-resize');
            }

            function onDragMove(e) {
                if (!isDragging || !isGameActive) return;

                // Prevent page scrolling on touch devices
                if (e.type === 'touchmove') {
                    e.preventDefault();
                }

                const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                const chestHeight = chestEl.offsetHeight;
                const screenHeight = window.innerHeight;
                
                // Calculate new top position, centered on cursor
                let newTop = clientY - chestHeight / 2;

                // Constrain to screen bounds (vertically)
                if (newTop < 0) newTop = 0;
                if (newTop + chestHeight > screenHeight) newTop = screenHeight - chestHeight;

                chestEl.style.top = `${newTop}px`;
            }

            // --- Game Loop ---
            function gameLoop(timestamp) {
                if (!isGameActive && activeCoins.length === 0) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                    lastTimestamp = 0;
                    return;
                }

                if (lastTimestamp === 0) {
                    lastTimestamp = timestamp;
                    animationFrameId = requestAnimationFrame(gameLoop);
                    return;
                }

                // Calculate time delta for smooth, consistent speed
                const deltaTime = (timestamp - lastTimestamp) / 1000; // seconds
                lastTimestamp = timestamp;

                const chestRect = chestEl.getBoundingClientRect();
                const totalDistanceToTravel = screenWidth + 80; // screen + 80px offset

                // Iterate backwards for safe removal
                for (let i = activeCoins.length - 1; i >= 0; i--) {
                    const coin = activeCoins[i];
                    
                    // Move coin using 'right' property, but time-based
                    // *** FIX: Default to -80 if style.right is not set ***
                    let currentRight = parseFloat(coin.element.style.right || '-80'); 
                    let newRight = currentRight + coinSpeed * deltaTime;
                    coin.element.style.right = `${newRight}px`;


                    // Check for collision
                    // We only need to check rect once, as it's more expensive
                    if (!coin.hasCollided) {
                        const coinRect = coin.element.getBoundingClientRect();
                        if (checkCollision(coinRect, chestRect)) {
                            // --- CATCH! ---
                            coin.hasCollided = true; // Mark as collided to prevent re-check
                            coin.element.remove();
                            activeCoins.splice(i, 1);
                            totalCoinsCaught++;
                            updateScore();
                        } 
                        // Check if off-screen (left)
                        else if (newRight > totalDistanceToTravel) {
                            coin.element.remove();
                            activeCoins.splice(i, 1);
                        }
                    }
                }

                animationFrameId = requestAnimationFrame(gameLoop);
            }

            function checkCollision(rect1, rect2) {
                // AABB (Axis-Aligned Bounding Box) collision detection
                return (
                    rect1.left < rect2.right &&
                    rect1.right > rect2.left &&
                    rect1.top < rect2.bottom &&
                    rect1.bottom > rect2.top
                );
            }

            function spawnCoin() {
                if (!isGameActive) return;

                const coinEl = document.createElement('div');
                coinEl.className = 'coin';
                
                // --- Constrained Spawning Logic ---
                const cardAreaHeight = document.getElementById('card-area').offsetHeight + document.getElementById('card-area').offsetTop;
                const minTop = cardAreaHeight + 20; // Min pixels from top to avoid card area
                const maxSpawnHeight = window.innerHeight * 0.90; // Max height to spawn (90% from top)
                const spawnableHeight = maxSpawnHeight - minTop;
                
                if (spawnableHeight <= minVerticalDistance) {
                    // console.warn("Spawnable height is too small, coins might cluster.");
                }

                let randomTop;
                let attempts = 0;
                
                // Try to find a spawn spot with good distance
                do {
                    randomTop = Math.random() * spawnableHeight + minTop;
                    attempts++;
                } while (Math.abs(randomTop - lastCoinTop) < minVerticalDistance && attempts < 5 && spawnableHeight > minVerticalDistance);
                
                lastCoinTop = randomTop; // Update last spawn position
                coinEl.style.top = `${randomTop}px`; 
                
                gameArea.appendChild(coinEl);
                activeCoins.push({
                    element: coinEl,
                    hasCollided: false
                });
            }

            function updateScore() {
                // Check if we've reached a new 5-coin milestone
                let newScoreLevel = Math.floor(totalCoinsCaught / 1);

                if (newScoreLevel > scoreCoinsOnCard && newScoreLevel <= 5) {
                    scoreCoinsOnCard = newScoreLevel;
                    
                    // Get the score coin to show
                    const coinToShow = scoreCoinElements[scoreCoinsOnCard - 1];
                    
                    // Trigger the bouncy animation
                    coinToShow.classList.remove('animate-bouncy-pop'); // reset animation
                    void coinToShow.offsetWidth; // force reflow
                    coinToShow.style.opacity = '1';
                    coinToShow.style.transform = 'scale(1)';
                    coinToShow.classList.add('animate-bouncy-pop');
                }

                // Check for game end
                if (scoreCoinsOnCard === 5) {
                    endGamePhase();
                }
            }

            function endGamePhase() {
                isGameActive = false; // Stops new coins from spawning
                clearInterval(coinSpawnInterval);
                coinSpawnInterval = null;
                
                // Show the withdraw button
                withdrawButton.classList.remove('hidden');
            }

            // --- UI/Modal Logic ---

            function showUsernamePopup() {
                usernamePopup.classList.remove('hidden');
                // Animate popup entrance
                setTimeout(() => {
                    popupContent.classList.remove('scale-95', 'opacity-0');
                    popupContent.classList.add('scale-100', 'opacity-100');
                }, 10); // Short delay to allow CSS to catch up
            }

            function showCongratsScreen() {
                const username = usernameInput.value.trim() || 'Anonymous';
                finalUsername.textContent = username;

                // Hide popup
                popupContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    usernamePopup.classList.add('hidden');
                }, 300);

                // Show congrats screen
                congratsScreen.classList.remove('hidden');
                setTimeout(() => {
                    congratsContent.classList.remove('scale-95', 'opacity-0');
                    congratsContent.classList.add('scale-100', 'opacity-100');
                }, 10);
                
                startConfetti();
            }

            function startConfetti() {
                const colors = ['#06b6d4', '#22d3ee', '#3b82f6', '#ec4899', '#fcd34d'];
                for (let i = 0; i < 100; i++) {
                    setTimeout(createConfettiParticle, i * 20); // Stagger creation
                }
            }

            function createConfettiParticle() {
                const particle = document.createElement('div');
                const colors = ['#06b6d4', '#22d3ee', '#3b82f6', '#ec4899', '#fcd34d'];
                
                particle.className = 'confetti';
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = Math.random() * 100 + 'vw';
                particle.style.width = (Math.random() * 8 + 4) + 'px';
                particle.style.height = (Math.random() * 8 + 4) + 'px';
                particle.style.borderRadius = Math.random() > 0.5 ? '50%' : '0%';
                particle.style.animationDuration = (Math.random() * 2 + 2) + 's';
                particle.style.transform = 'rotate(' + Math.random() * 360 + 'deg)';
                
                confettiContainer.appendChild(particle);
                
                // Remove particle after animation
                setTimeout(() => particle.remove(), 4000);
            }

            function resetGame() {
                // Reset state
                totalCoinsCaught = 0;
                scoreCoinsOnCard = 0;
                isGameActive = false; // Game is inactive until played again
                
                // Clear active coins
                activeCoins.forEach(coin => coin.element.remove());
                activeCoins = [];

                // Hide UI elements
                congratsContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    congratsScreen.classList.add('hidden');
                    confettiContainer.innerHTML = ''; // Clear old confetti
                }, 500);

                withdrawButton.classList.add('hidden');
                usernameInput.value = '';

                // Reset chest position to its initial hidden state
                chestEl.style.opacity = '0';
                chestEl.style.transform = 'translateY(-50%) translateX(-100px)'; // Reset to initial hidden state
                chestEl.style.top = ''; // Clear inline top style
                chestEl.style.bottom = 'auto'; // Re-apply auto bottom for `translate-y-1/2` to work from center

                // Reset score coins
                scoreCoinElements.forEach(coin => {
                    coin.style.opacity = '0';
                    coin.style.transform = 'scale(0)';
                    coin.classList.remove('animate-bouncy-pop');
                });
                
                // Show start screen again
                startScreen.classList.remove('hidden');
            }

            function startGame() {
                startScreen.classList.add('hidden'); // Hide start screen
                
                // Animate chest in
                chestEl.style.opacity = '1';
                chestEl.style.transform = 'translateY(-50%) translateX(0)'; // Slide into place
                
                // Allow some time for chest animation before starting game logic
                setTimeout(() => {
                    isGameActive = true;
                    // Start spawning coins
                    if (coinSpawnInterval) clearInterval(coinSpawnInterval);
                    coinSpawnInterval = setInterval(spawnCoin, 1200); // Spawn a coin every 1.2 seconds (slower freq)
                    spawnCoin(); // Spawn one immediately

                    // Start game loop
                    if (animationFrameId) cancelAnimationFrame(animationFrameId);
                    lastTimestamp = 0; // Reset timestamp for new game
                    animationFrameId = requestAnimationFrame(gameLoop);
                }, 500); // Match this duration with chest transition duration
            }

            // --- Event Listeners ---
            chestEl.addEventListener('mousedown', onDragStart);
            window.addEventListener('mouseup', onDragEnd);
            window.addEventListener('mousemove', onDragMove);

            chestEl.addEventListener('touchstart', onDragStart, { passive: false });
            window.addEventListener('touchend', onDragEnd);
            window.addEventListener('touchmove', onDragMove, { passive: false });

            startButton.addEventListener('click', startGame); // New: Start button listener
            withdrawButton.addEventListener('click', showUsernamePopup);
            proceedButton.addEventListener('click', showCongratsScreen);
            playAgainButton.addEventListener('click', resetGame);
        });
    </script>
</body>
</html>

